/*************************

SafariÊµèËßàÂô®ÊâìÂºÄÁôªÂΩï https://home.m.jd.com/myJd/newhome.action ÁÇπÂáª"ÊàëÁöÑ"È°µÈù¢
ÊàñËÄÖ‰ΩøÁî®ÊóßÁâàÁΩëÂùÄ https://bean.m.jd.com/bean/signIndex.action ÁÇπÂáªÁ≠æÂà∞Âπ∂‰∏îÂá∫Áé∞Á≠æÂà∞Êó•ÂéÜ
Â¶ÇÊûúÈÄöÁü•Ëé∑ÂèñCookieÊàêÂäü, ÂàôÂèØ‰ª•‰ΩøÁî®Ê≠§Á≠æÂà∞ËÑöÊú¨. Ê≥®: ËØ∑ÂãøÂú®‰∫¨‰∏úAPPÂÜÖËé∑Âèñ!!!

ÂºÄÂêØÊäìÂåÖappÂêé, SafariÊµèËßàÂô®ÁôªÂΩï https://home.m.jd.com/myJd/newhome.action ÁÇπÂáª‰∏™‰∫∫‰∏≠ÂøÉÈ°µÈù¢Âêé, ËøîÂõûÊäìÂåÖappÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó info/GetJDUserInfoUnion Â§çÂà∂ËØ∑Ê±ÇÂ§¥CookieÂ≠óÊÆµÂ°´ÂÖ•json‰∏≤Êï∞ÊçÆÂÜÖÂç≥ÂèØ
*/

var Key = ''; //ËØ•ÂèÇÊï∞Â∑≤Â∫üÂºÉ; ‰ªÖÁî®‰∫é‰∏ãÊ∏∏ËÑöÊú¨ÁöÑÂÖºÂÆπ, ËØ∑‰ΩøÁî®json‰∏≤Êï∞ÊçÆ ‚Üì

var DualKey = ''; //ËØ•ÂèÇÊï∞Â∑≤Â∫üÂºÉ; ‰ªÖÁî®‰∫é‰∏ãÊ∏∏ËÑöÊú¨ÁöÑÂÖºÂÆπ, ËØ∑‰ΩøÁî®json‰∏≤Êï∞ÊçÆ  ‚Üì

var OtherKey = ``; //Êó†ÈôêË¥¶Âè∑Cookie json‰∏≤Êï∞ÊçÆ, ËØ∑‰∏•Ê†ºÊåâÁÖßjsonÊ†ºÂºèÂ°´ÂÜô, ÂÖ∑‰ΩìÊ†ºÂºèËØ∑Áúã‰ª•‰∏ãÊ†∑‰æã:

/*‰ª•‰∏ãÊ†∑‰æã‰∏∫ÂèåË¥¶Âè∑("cookie"‰∏∫ÂøÖÈ°ª,ÂÖ∂‰ªñÂèØÈÄâ), Á¨¨‰∏Ä‰∏™Ë¥¶Âè∑‰ªÖÂåÖÂê´Cookie, Á¨¨‰∫å‰∏™Ë¥¶Âè∑ÂåÖÂê´CookieÂíåÈáëËûçÁ≠æÂà∞Body: 

var OtherKey = `[{
  "cookie": "pt_key=xxx;pt_pin=yyy;"
}, {
  "cookie": "pt_key=yyy;pt_pin=xxx;",
  "jrBody": "reqData=xxx"
}]`

[mitm]
hostname = ms.jr.jd.com, me-api.jd.com, api.m.jd.com

*************************/

var LogDetails = false; //ÊòØÂê¶ÂºÄÂêØÂìçÂ∫îÊó•Âøó, trueÂàôÂºÄÂêØ

var stop = '0'; //Ëá™ÂÆö‰πâÂª∂ËøüÁ≠æÂà∞, Âçï‰ΩçÊØ´Áßí. ÈªòËÆ§ÂàÜÊâπÂπ∂ÂèëÊó†Âª∂Ëøü; ËØ•ÂèÇÊï∞Êé•ÂèóÈöèÊú∫ÊàñÊåáÂÆöÂª∂Ëøü(‰æã: '2000'ÂàôË°®Á§∫Âª∂Ëøü2Áßí; '2000-5000'ÂàôË°®Á§∫Âª∂ËøüÊúÄÂ∞è2Áßí,ÊúÄÂ§ß5ÁßíÂÜÖÁöÑÈöèÊú∫Âª∂Ëøü), Â¶ÇÂ°´ÂÖ•Âª∂ËøüÂàôÂàáÊç¢È°∫Â∫èÁ≠æÂà∞(ËÄóÊó∂ËæÉÈïø), SurgeÁî®Êà∑ËØ∑Ê≥®ÊÑèÂú®SurgeUIÁïåÈù¢Ë∞ÉÊï¥ËÑöÊú¨Ë∂ÖÊó∂; Ê≥®: ËØ•ÂèÇÊï∞Node.jsÊàñJSboxÁéØÂ¢É‰∏ãÂ∑≤ÈÖçÁΩÆÊï∞ÊçÆÊåÅ‰πÖÂåñ, ÁïôÁ©∫(var stop = '')Âç≥ÂèØÊ∏ÖÈô§.

var DeleteCookie = false; //ÊòØÂê¶Ê∏ÖÈô§ÊâÄÊúâCookie, trueÂàôÂºÄÂêØ.

var boxdis = true; //ÊòØÂê¶ÂºÄÂêØËá™Âä®Á¶ÅÁî®, falseÂàôÂÖ≥Èó≠. ËÑöÊú¨ËøêË°åÂ¥©Ê∫ÉÊó∂(Â¶ÇVPNÊñ≠Ëøû), ‰∏ãÊ¨°ËøêË°åÊó∂Â∞ÜËá™Âä®Á¶ÅÁî®Áõ∏ÂÖ≥Â¥©Ê∫ÉÊé•Âè£(‰ªÖÈÉ®ÂàÜÊé•Âè£ÂêØÁî®), Â¥©Ê∫ÉÊó∂ÂèØËÉΩ‰ºöËØØÁ¶ÅÁî®Ê≠£Â∏∏Êé•Âè£. (ËØ•ÈÄâÈ°π‰ªÖÈÄÇÁî®‰∫éQX,Surge,Loon)

var ReDis = false; //ÊòØÂê¶ÁßªÈô§ÊâÄÊúâÁ¶ÅÁî®ÂàóË°®, trueÂàôÂºÄÂêØ. ÈÄÇÁî®‰∫éËß¶ÂèëËá™Âä®Á¶ÅÁî®Âêé, ÈúÄË¶ÅÂÜçÊ¨°ÂêØÁî®Êé•Âè£ÁöÑÊÉÖÂÜµ. (ËØ•ÈÄâÈ°π‰ªÖÈÄÇÁî®‰∫éQX,Surge,Loon)

var out = 0; //Êé•Âè£Ë∂ÖÊó∂ÈÄÄÂá∫, Áî®‰∫éÂèØËÉΩÂèëÁîüÁöÑÁΩëÁªú‰∏çÁ®≥ÂÆö, 0ÂàôÂÖ≥Èó≠. Â¶ÇQXÊó•ÂøóÂá∫Áé∞Â§ßÈáè"JS Context timeout"ÂêéËÑöÊú¨‰∏≠Êñ≠Êó∂, Âª∫ËÆÆÂ°´ÂÜô6000

var $nobyda = nobyda();

var merge = {};

var KEY = '';

async function all(cookie, jrBody) {
  KEY = cookie;
  merge = {};
  $nobyda.num++;
  switch (stop) {
    case 0:
      await Promise.all([
        JingDongBean(stop) //‰∫¨‰∏ú‰∫¨Ë±Ü
      ]);
      break;
    default:
      await JingDongBean(0) //‰∫¨‰∏ú‰∫¨Ë±Ü
      break;
  }
  await Promise.all([
    TotalBean() //ÊÄª‰∫¨Ë±ÜÊü•ËØ¢
  ]);
  await notify(); //ÈÄöÁü•Ê®°Âùó
}

function notify() {
  return new Promise(resolve => {
    try {
      var bean = 0;
      var success = 0;
      var fail = 0;
      var err = 0;
      var notify = '';
      for (var i in merge) {
        bean += merge[i].bean ? Number(merge[i].bean) : 0
        success += merge[i].success ? Number(merge[i].success) : 0
        fail += merge[i].fail ? Number(merge[i].fail) : 0
        err += merge[i].error ? Number(merge[i].error) : 0
        notify += merge[i].notify ? "\n" + merge[i].notify : ""
      }
      var beans = merge.TotalBean && merge.TotalBean.Qbear ? `${merge.TotalBean.Qbear}‰∫¨Ë±Ü` : ""
      var Tbean = bean ? `${bean.toFixed(0)}‰∫¨Ë±Ü` : ""
      var Ts = success ? `ÊàêÂäü${success}‰∏™${fail||err?`, `:``}` : ``
      var Tf = fail ? `Â§±Ë¥•${fail}‰∏™${err?`, `:``}` : ``
      var Te = err ? `ÈîôËØØ${err}‰∏™` : ``
      var one = `„ÄêÁ≠æÂà∞Ê¶ÇËßà„Äë:  ${Ts+Tf+Te}${Ts||Tf||Te?`\n`:`Ëé∑ÂèñÂ§±Ë¥•\n`}`
      var DName = merge.TotalBean && merge.TotalBean.nickname ? merge.TotalBean.nickname : "Ëé∑ÂèñÂ§±Ë¥•"
      var cnNum = ["Èõ∂", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù", "ÂçÅ"];
      const Name = DualKey || OtherKey.length > 1 ? `„ÄêÁ≠æÂà∞Âè∑${cnNum[$nobyda.num]||$nobyda.num}„Äë:  ${DName}\n` : ``
      const disables = $nobyda.read("JD_DailyBonusDisables")
      const amount = disables ? disables.split(",").length : 0
      $nobyda.notify("", "", Name + one + notify, {
        'media-url': $nobyda.headUrl || 'https://cdn.jsdelivr.net/gh/NobyDa/mini@master/Color/jd.png'
      });
      $nobyda.headUrl = null;
      if ($nobyda.isJSBox) {
        $nobyda.st = (typeof($nobyda.st) == 'undefined' ? '' : $nobyda.st) + Name + one + "\n"
      }
    } catch (eor) {
      $nobyda.notify("ÈÄöÁü•Ê®°Âùó " + eor.name + "‚ÄºÔ∏è", JSON.stringify(eor), eor.message)
    } finally {
      resolve()
    }
  });
}

(async function ReadCookie() {
  const EnvInfo = $nobyda.isJSBox ? "JD_Cookie" : "CookieJD";
  const EnvInfo2 = $nobyda.isJSBox ? "JD_Cookie2" : "CookieJD2";
  const EnvInfo3 = $nobyda.isJSBox ? "JD_Cookies" : "CookiesJD";
  const move = CookieMove($nobyda.read(EnvInfo) || Key, $nobyda.read(EnvInfo2) || DualKey, EnvInfo, EnvInfo2, EnvInfo3);
  const cookieSet = $nobyda.read(EnvInfo3);
  if (DeleteCookie) {
    const write = $nobyda.write("", EnvInfo3);
    throw new Error(`CookieÊ∏ÖÈô§${write?`ÊàêÂäü`:`Â§±Ë¥•`}, ËØ∑ÊâãÂä®ÂÖ≥Èó≠ËÑöÊú¨ÂÜÖ"DeleteCookie"ÈÄâÈ°π`);
  } else if ($nobyda.isRequest) {
    GetCookie()
  } else if (Key || DualKey || (OtherKey || cookieSet || '[]') != '[]') {
    if (($nobyda.isJSBox || $nobyda.isNode) && stop !== '0') $nobyda.write(stop, "JD_DailyBonusDelay");
    out = parseInt($nobyda.read("JD_DailyBonusTimeOut")) || out;
    stop = Wait($nobyda.read("JD_DailyBonusDelay"), true) || Wait(stop, true);
    boxdis = $nobyda.read("JD_Crash_disable") === "false" || $nobyda.isNode || $nobyda.isJSBox ? false : boxdis;
    LogDetails = $nobyda.read("JD_DailyBonusLog") === "true" || LogDetails;
    ReDis = ReDis ? $nobyda.write("", "JD_DailyBonusDisables") : "";
    $nobyda.num = 0;
    if (Key) await all(Key);
    if (DualKey && DualKey !== Key) await all(DualKey);
    if ((OtherKey || cookieSet || '[]') != '[]') {
      try {
        OtherKey = checkFormat([...JSON.parse(OtherKey || '[]'), ...JSON.parse(cookieSet || '[]')]);
        const updateSet = OtherKey.length ? $nobyda.write(JSON.stringify(OtherKey, null, 2), EnvInfo3) : '';
        for (let i = 0; i < OtherKey.length; i++) {
          const ck = OtherKey[i].cookie;
          const jr = OtherKey[i].jrBody;
          if (ck != Key && ck != DualKey) {
            await all(ck, jr)
          }
        }
      } catch (e) {
        throw new Error(`Ë¥¶Âè∑CookieËØªÂèñÂ§±Ë¥•, ËØ∑Ê£ÄÊü•JsonÊ†ºÂºè. \n${e.message}`)
      }
    }
    $nobyda.time();
  } else {
    throw new Error('ËÑöÊú¨ÁªàÊ≠¢, Êú™Ëé∑ÂèñCookie ‚ÄºÔ∏è')
  }
})().catch(e => {
  $nobyda.notify("‰∫¨‰∏úÁ≠æÂà∞", "", e.message || JSON.stringify(e))
}).finally(() => {
  if ($nobyda.isJSBox) $intents.finish($nobyda.st);
  $nobyda.done();
})

function JingDongBean(s) {
  merge.JDBean = {};
  return new Promise(resolve => {
    if (disable("JDBean")) return resolve()
    setTimeout(() => {
      const JDBUrl = {
        url: 'https://api.m.jd.com/client.action?functionId=signBeanAct&appid=ld',
        headers: {
          Cookie: KEY
        },
        body: ''
      };
      $nobyda.post(JDBUrl, function(error, response, data) {
        try {
          if (error) {
            throw new Error(error)
          } else {
            const cc = JSON.parse(data)
            const Details = LogDetails ? "response:\n" + data : '';
            if (cc.code == 3) {
              console.log("\n" + "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±ÜCookieÂ§±Êïà " + Details)
              merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: Â§±Ë¥•, ÂéüÂõ†: CookieÂ§±Êïà‚ÄºÔ∏è"
              merge.JDBean.fail = 1
            } else if (data.match(/Ë∑≥ËΩ¨Ëá≥ÊãºÂõæ/)) {
              merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: Â§±Ë¥•, ÈúÄË¶ÅÊãºÂõæÈ™åËØÅ ‚ö†Ô∏è"
              merge.JDBean.fail = 1
            } else if (data.match(/\"status\":\"?1\"?/)) {
              console.log("\n" + "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±ÜÁ≠æÂà∞ÊàêÂäü " + Details)
              if (data.match(/dailyAward/)) {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: ÊàêÂäü, ÊòéÁªÜ: " + cc.data.dailyAward.beanAward.beanCount + "‰∫¨Ë±Ü üê∂"
                merge.JDBean.bean = cc.data.dailyAward.beanAward.beanCount
              } else if (data.match(/continuityAward/)) {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: ÊàêÂäü, ÊòéÁªÜ: " + cc.data.continuityAward.beanAward.beanCount + "‰∫¨Ë±Ü üê∂"
                merge.JDBean.bean = cc.data.continuityAward.beanAward.beanCount
              } else if (data.match(/Êñ∞‰∫∫Á≠æÂà∞/)) {
                const quantity = data.match(/beanCount\":\"(\d+)\".+‰ªäÂ§©/)
                merge.JDBean.bean = quantity ? quantity[1] : 0
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: ÊàêÂäü, ÊòéÁªÜ: " + (quantity ? quantity[1] : "Êó†") + "‰∫¨Ë±Ü üê∂"
              } else {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: ÊàêÂäü, ÊòéÁªÜ: Êó†‰∫¨Ë±Ü üê∂"
              }
              merge.JDBean.success = 1
            } else {
              merge.JDBean.fail = 1
              console.log("\n" + "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±ÜÁ≠æÂà∞Â§±Ë¥• " + Details)
              if (data.match(/(Â∑≤Á≠æÂà∞|Êñ∞‰∫∫Á≠æÂà∞)/)) {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: Â§±Ë¥•, ÂéüÂõ†: Â∑≤Á≠æËøá ‚ö†Ô∏è"
              } else if (data.match(/‰∫∫Êï∞ËæÉÂ§ö|S101/)) {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: Â§±Ë¥•, Á≠æÂà∞‰∫∫Êï∞ËæÉÂ§ö ‚ö†Ô∏è"
              } else {
                merge.JDBean.notify = "‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü: Â§±Ë¥•, ÂéüÂõ†: Êú™Áü• ‚ö†Ô∏è"
              }
            }
          }
        } catch (eor) {
          $nobyda.AnError("‰∫¨‰∏úÂïÜÂüé-‰∫¨Ë±Ü", "JDBean", eor, response, data)
        } finally {
          resolve()
        }
      })
    }, s)
    if (out) setTimeout(resolve, out + s)
  });
}


function TotalBean() {
  merge.TotalBean = {};
  return new Promise(resolve => {
    if (disable("Qbear")) return resolve()
    $nobyda.get({
      url: 'https://me-api.jd.com/user_new/info/GetJDUserInfoUnion',
      headers: {
        Cookie: KEY
      }
    }, (error, response, data) => {
      try {
        if (error) throw new Error(error);
        const Details = LogDetails ? "response:\n" + data : '';
        const cc = JSON.parse(data)
        if (cc.msg == 'success' && cc.retcode == 0) {
          merge.TotalBean.nickname = cc.data.userInfo.baseInfo.nickname || ""
          merge.TotalBean.Qbear = cc.data.assetInfo.beanNum || 0
          $nobyda.headUrl = cc.data.userInfo.baseInfo.headImageUrl || ""
          console.log(`\n‰∫¨‰∏ú-ÊÄª‰∫¨Ë±ÜÊü•ËØ¢ÊàêÂäü ${Details}`)
        } else {
          const name = decodeURIComponent(KEY.split(/pt_pin=(.+?);/)[1] || '');
          merge.TotalBean.nickname = cc.retcode == 1001 ? `${name} (CKÂ§±Êïà‚ÄºÔ∏è)` : "";
          console.log(`\n‰∫¨‰∏ú-ÊÄª‰∫¨Ë±ÜÊü•ËØ¢Â§±Ë¥• ${Details}`)
        }
      } catch (eor) {
        $nobyda.AnError("Ë¥¶Êà∑‰∫¨Ë±Ü-Êü•ËØ¢", "TotalBean", eor, response, data)
      } finally {
        resolve()
      }
    })
    if (out) setTimeout(resolve, out)
  });
}

function disable(Val, name, way) {
  const read = $nobyda.read("JD_DailyBonusDisables")
  const annal = $nobyda.read("JD_Crash_" + Val)
  if (annal && way == 1 && boxdis) {
    var Crash = $nobyda.write("", "JD_Crash_" + Val)
    if (read) {
      if (read.indexOf(Val) == -1) {
        var Crash = $nobyda.write(`${read},${Val}`, "JD_DailyBonusDisables")
        console.log(`\n${name}-Ëß¶ÂèëËá™Âä®Á¶ÅÁî® ‚ÄºÔ∏è`)
        merge[Val].notify = `${name}: Â¥©Ê∫É, Ëß¶ÂèëËá™Âä®Á¶ÅÁî® ‚ÄºÔ∏è`
        merge[Val].error = 1
        $nobyda.disable = 1
      }
    } else {
      var Crash = $nobyda.write(Val, "JD_DailyBonusDisables")
      console.log(`\n${name}-Ëß¶ÂèëËá™Âä®Á¶ÅÁî® ‚ÄºÔ∏è`)
      merge[Val].notify = `${name}: Â¥©Ê∫É, Ëß¶ÂèëËá™Âä®Á¶ÅÁî® ‚ÄºÔ∏è`
      merge[Val].error = 1
      $nobyda.disable = 1
    }
    return true
  } else if (way == 1 && boxdis) {
    var Crash = $nobyda.write(name, "JD_Crash_" + Val)
  } else if (way == 2 && annal) {
    var Crash = $nobyda.write("", "JD_Crash_" + Val)
  }
  if (read && read.indexOf(Val) != -1) {
    return true
  } else {
    return false
  }
}

function Wait(readDelay, ini) {
  if (!readDelay || readDelay === '0') return 0
  if (typeof(readDelay) == 'string') {
    var readDelay = readDelay.replace(/"|ÔºÇ|'|Ôºá/g, ''); //prevent novice
    if (readDelay.indexOf('-') == -1) return parseInt(readDelay) || 0;
    const raw = readDelay.split("-").map(Number);
    const plan = parseInt(Math.random() * (raw[1] - raw[0] + 1) + raw[0], 10);
    if (ini) console.log(`\nÂàùÂßãÂåñÈöèÊú∫Âª∂Ëøü: ÊúÄÂ∞è${raw[0]/1000}Áßí, ÊúÄÂ§ß${raw[1]/1000}Áßí`);
    // else console.log(`\nÈ¢ÑËÆ°Á≠âÂæÖ: ${(plan / 1000).toFixed(2)}Áßí`);
    return ini ? readDelay : plan
  } else if (typeof(readDelay) == 'number') {
    return readDelay > 0 ? readDelay : 0
  } else return 0
}

function CookieMove(oldCk1, oldCk2, oldKey1, oldKey2, newKey) {
  let update;
  const move = (ck, del) => {
    console.log(`‰∫¨‰∏ú${del}ÂºÄÂßãËøÅÁßª!`);
    update = CookieUpdate(null, ck).total;
    update = $nobyda.write(JSON.stringify(update, null, 2), newKey);
    update = $nobyda.write("", del);
  }
  if (oldCk1) {
    const write = move(oldCk1, oldKey1);
  }
  if (oldCk2) {
    const write = move(oldCk2, oldKey2);
  }
}

function checkFormat(value) { //check format and delete duplicates
  let n, k, c = {};
  return value.reduce((t, i) => {
    k = ((i.cookie || '').match(/(pt_key|pt_pin)=.+?;/g) || []).sort();
    if (k.length == 2) {
      if ((n = k[1]) && !c[n]) {
        i.userName = i.userName ? i.userName : decodeURIComponent(n.split(/pt_pin=(.+?);/)[1]);
        i.cookie = k.join('')
        if (i.jrBody && !i.jrBody.includes('reqData=')) {
          console.log(`ÂºÇÂ∏∏Èí¢ÈïöBodyÂ∑≤ËøáÊª§: ${i.jrBody}`)
          delete i.jrBody;
        }
        c[n] = t.push(i);
      }
    } else {
      console.log(`ÂºÇÂ∏∏‰∫¨‰∏úCookieÂ∑≤ËøáÊª§: ${i.cookie}`)
    }
    return t;
  }, [])
}

function CookieUpdate(oldValue, newValue, path = 'cookie') {
  let item, type, name = (oldValue || newValue || '').split(/pt_pin=(.+?);/)[1];
  let total = $nobyda.read('CookiesJD');
  try {
    total = checkFormat(JSON.parse(total || '[]'));
  } catch (e) {
    $nobyda.notify("‰∫¨‰∏úÁ≠æÂà∞", "", "Cookie JSONÊ†ºÂºè‰∏çÊ≠£Á°Æ, Âç≥Â∞ÜÊ∏ÖÁ©∫\nÂèØÂâçÂæÄÊó•ÂøóÊü•ÁúãËØ•Êï∞ÊçÆÂÜÖÂÆπ!");
    console.log(`‰∫¨‰∏úÁ≠æÂà∞Cookie JSONÊ†ºÂºèÂºÇÂ∏∏: ${e.message||e}\nÊóßÊï∞ÊçÆÂÜÖÂÆπ: ${total}`);
    total = [];
  }
  for (let i = 0; i < total.length; i++) {
    if (total[i].cookie && new RegExp(`pt_pin=${name};`).test(total[i].cookie)) {
      item = i;
      break;
    }
  }
  if (newValue && item !== undefined) {
    type = total[item][path] === newValue ? -1 : 2;
    total[item][path] = newValue;
    item = item + 1;
  } else if (newValue && path === 'cookie') {
    total.push({
      cookie: newValue
    });
    type = 1;
    item = total.length;
  }
  return {
    total: checkFormat(total),
    type, //-1: same, 1: add, 2:update
    item,
    name: decodeURIComponent(name)
  };
}

function GetCookie() {
  const req = $request;
  if (req.method != 'OPTIONS' && req.headers) {
    const CV = (req.headers['Cookie'] || req.headers['cookie'] || '');
    const ckItems = CV.match(/(pt_key|pt_pin)=.+?;/g);
    if (/^https:\/\/(me-|)api(\.m|)\.jd\.com\/(client\.|user_new)/.test(req.url)) {
      if (ckItems && ckItems.length == 2) {
        const value = CookieUpdate(null, ckItems.join(''))
        if (value.type !== -1) {
          const write = $nobyda.write(JSON.stringify(value.total, null, 2), "CookiesJD")
          $nobyda.notify(`Áî®Êà∑Âêç: ${value.name}`, ``, `${value.type==2?`Êõ¥Êñ∞`:`ÂÜôÂÖ•`}‰∫¨‰∏ú [Ë¥¶Âè∑${value.item}] Cookie${write?`ÊàêÂäü üéâ`:`Â§±Ë¥• ‚ÄºÔ∏è`}`)
        } else {
          console.log(`\nÁî®Êà∑Âêç: ${value.name}\n‰∏éÂéÜÂè≤‰∫¨‰∏ú [Ë¥¶Âè∑${value.item}] CookieÁõ∏Âêå, Ë∑≥ËøáÂÜôÂÖ• ‚ö†Ô∏è`)
        }
      } else {
        throw new Error("ÂÜôÂÖ•CookieÂ§±Ë¥•, ÂÖ≥ÈîÆÂÄºÁº∫Â§±\nÂèØËÉΩÂéüÂõ†: ÈùûÁΩëÈ°µËé∑Âèñ ‚ÄºÔ∏è");
      }
    } else if (/^https:\/\/ms\.jr\.jd\.com\/gw\/generic\/hy\/h5\/m\/appSign\?/.test(req.url) && req.body) {
      const value = CookieUpdate(CV, req.body, 'jrBody');
      if (value.type) {
        const write = $nobyda.write(JSON.stringify(value.total, null, 2), "CookiesJD")
        $nobyda.notify(`Áî®Êà∑Âêç: ${value.name}`, ``, `Ëé∑Âèñ‰∫¨‰∏ú [Ë¥¶Âè∑${value.item}] Èí¢ÈïöBody${write?`ÊàêÂäü üéâ`:`Â§±Ë¥• ‚ÄºÔ∏è`}`)
      } else {
        throw new Error("ÂÜôÂÖ•Èí¢ÈïöBodyÂ§±Ë¥•\nÊú™Ëé∑ÂèñËØ•Ë¥¶Âè∑CookieÊàñÂÖ≥ÈîÆÂÄºÁº∫Â§±‚ÄºÔ∏è");
      }
    } else if (req.url === 'http://www.apple.com/') {
      throw new Error("Á±ªÂûãÈîôËØØ, ÊâãÂä®ËøêË°åËØ∑ÈÄâÊã©‰∏ä‰∏ãÊñáÁéØÂ¢É‰∏∫Cron ‚ö†Ô∏è");
    }
  } else if (!req.headers) {
    throw new Error("ÂÜôÂÖ•CookieÂ§±Ë¥•, ËØ∑Ê£ÄÊü•ÂåπÈÖçURLÊàñÈÖçÁΩÆÂÜÖËÑöÊú¨Á±ªÂûã ‚ö†Ô∏è");
  }
}

// Modified from yichahucha
function nobyda() {
  const start = Date.now()
  const isRequest = typeof $request != "undefined"
  const isSurge = typeof $httpClient != "undefined"
  const isQuanX = typeof $task != "undefined"
  const isLoon = typeof $loon != "undefined"
  const isJSBox = typeof $app != "undefined" && typeof $http != "undefined"
  const isNode = typeof require == "function" && !isJSBox;
  const NodeSet = 'CookieSet.json'
  const node = (() => {
    if (isNode) {
      const request = require('request');
      const fs = require("fs");
      const path = require("path");
      return ({
        request,
        fs,
        path
      })
    } else {
      return (null)
    }
  })()
  const notify = (title, subtitle, message, rawopts) => {
    const Opts = (rawopts) => { //Modified from https://github.com/chavyleung/scripts/blob/master/Env.js
      if (!rawopts) return rawopts
      if (typeof rawopts === 'string') {
        if (isLoon) return rawopts
        else if (isQuanX) return {
          'open-url': rawopts
        }
        else if (isSurge) return {
          url: rawopts
        }
        else return undefined
      } else if (typeof rawopts === 'object') {
        if (isLoon) {
          let openUrl = rawopts.openUrl || rawopts.url || rawopts['open-url']
          let mediaUrl = rawopts.mediaUrl || rawopts['media-url']
          return {
            openUrl,
            mediaUrl
          }
        } else if (isQuanX) {
          let openUrl = rawopts['open-url'] || rawopts.url || rawopts.openUrl
          let mediaUrl = rawopts['media-url'] || rawopts.mediaUrl
          return {
            'open-url': openUrl,
            'media-url': mediaUrl
          }
        } else if (isSurge) {
          let openUrl = rawopts.url || rawopts.openUrl || rawopts['open-url']
          return {
            url: openUrl
          }
        }
      } else {
        return undefined
      }
    }
    console.log(`${title}\n${subtitle}\n${message}`)
    if (isQuanX) $notify(title, subtitle, message, Opts(rawopts))
    if (isSurge) $notification.post(title, subtitle, message, Opts(rawopts))
    if (isJSBox) $push.schedule({
      title: title,
      body: subtitle ? subtitle + "\n" + message : message
    })
  }
  const write = (value, key) => {
    if (isQuanX) return $prefs.setValueForKey(value, key)
    if (isSurge) return $persistentStore.write(value, key)
    if (isNode) {
      try {
        if (!node.fs.existsSync(node.path.resolve(__dirname, NodeSet)))
          node.fs.writeFileSync(node.path.resolve(__dirname, NodeSet), JSON.stringify({}));
        const dataValue = JSON.parse(node.fs.readFileSync(node.path.resolve(__dirname, NodeSet)));
        if (value) dataValue[key] = value;
        if (!value) delete dataValue[key];
        return node.fs.writeFileSync(node.path.resolve(__dirname, NodeSet), JSON.stringify(dataValue));
      } catch (er) {
        return AnError('Node.jsÊåÅ‰πÖÂåñÂÜôÂÖ•', null, er);
      }
    }
    if (isJSBox) {
      if (!value) return $file.delete(`shared://${key}.txt`);
      return $file.write({
        data: $data({
          string: value
        }),
        path: `shared://${key}.txt`
      })
    }
  }
  const read = (key) => {
    if (isQuanX) return $prefs.valueForKey(key)
    if (isSurge) return $persistentStore.read(key)
    if (isNode) {
      try {
        if (!node.fs.existsSync(node.path.resolve(__dirname, NodeSet))) return null;
        const dataValue = JSON.parse(node.fs.readFileSync(node.path.resolve(__dirname, NodeSet)))
        return dataValue[key]
      } catch (er) {
        return AnError('Node.jsÊåÅ‰πÖÂåñËØªÂèñ', null, er)
      }
    }
    if (isJSBox) {
      if (!$file.exists(`shared://${key}.txt`)) return null;
      return $file.read(`shared://${key}.txt`).string
    }
  }
  const adapterStatus = (response) => {
    if (response) {
      if (response.status) {
        response["statusCode"] = response.status
      } else if (response.statusCode) {
        response["status"] = response.statusCode
      }
    }
    return response
  }
  const get = (options, callback) => {
    options.headers['User-Agent'] = 'JD4iPhone/167169 (iPhone; iOS 13.4.1; Scale/3.00)'
    if (isQuanX) {
      if (typeof options == "string") options = {
        url: options
      }
      options["method"] = "GET"
      //options["opts"] = {
      //  "hints": false
      //}
      $task.fetch(options).then(response => {
        callback(null, adapterStatus(response), response.body)
      }, reason => callback(reason.error, null, null))
    }
    if (isSurge) {
      options.headers['X-Surge-Skip-Scripting'] = false
      $httpClient.get(options, (error, response, body) => {
        callback(error, adapterStatus(response), body)
      })
    }
    if (isNode) {
      node.request(options, (error, response, body) => {
        callback(error, adapterStatus(response), body)
      })
    }
    if (isJSBox) {
      if (typeof options == "string") options = {
        url: options
      }
      options["header"] = options["headers"]
      options["handler"] = function(resp) {
        let error = resp.error;
        if (error) error = JSON.stringify(resp.error)
        let body = resp.data;
        if (typeof body == "object") body = JSON.stringify(resp.data);
        callback(error, adapterStatus(resp.response), body)
      };
      $http.get(options);
    }
  }
  const post = (options, callback) => {
    options.headers['User-Agent'] = 'JD4iPhone/167169 (iPhone; iOS 13.4.1; Scale/3.00)'
    if (options.body) options.headers['Content-Type'] = 'application/x-www-form-urlencoded'
    if (isQuanX) {
      if (typeof options == "string") options = {
        url: options
      }
      options["method"] = "POST"
      //options["opts"] = {
      //  "hints": false
      //}
      $task.fetch(options).then(response => {
        callback(null, adapterStatus(response), response.body)
      }, reason => callback(reason.error, null, null))
    }
    if (isSurge) {
      options.headers['X-Surge-Skip-Scripting'] = false
      $httpClient.post(options, (error, response, body) => {
        callback(error, adapterStatus(response), body)
      })
    }
    if (isNode) {
      node.request.post(options, (error, response, body) => {
        callback(error, adapterStatus(response), body)
      })
    }
    if (isJSBox) {
      if (typeof options == "string") options = {
        url: options
      }
      options["header"] = options["headers"]
      options["handler"] = function(resp) {
        let error = resp.error;
        if (error) error = JSON.stringify(resp.error)
        let body = resp.data;
        if (typeof body == "object") body = JSON.stringify(resp.data)
        callback(error, adapterStatus(resp.response), body)
      }
      $http.post(options);
    }
  }
  const AnError = (name, keyname, er, resp, body) => {
    if (typeof(merge) != "undefined" && keyname) {
      if (!merge[keyname].notify) {
        merge[keyname].notify = `${name}: ÂºÇÂ∏∏, Â∑≤ËæìÂá∫Êó•Âøó ‚ÄºÔ∏è`
      } else {
        merge[keyname].notify += `\n${name}: ÂºÇÂ∏∏, Â∑≤ËæìÂá∫Êó•Âøó ‚ÄºÔ∏è (2)`
      }
      merge[keyname].error = 1
    }
    return console.log(`\n‚ÄºÔ∏è${name}ÂèëÁîüÈîôËØØ\n‚ÄºÔ∏èÂêçÁß∞: ${er.name}\n‚ÄºÔ∏èÊèèËø∞: ${er.message}${JSON.stringify(er).match(/\"line\"/)?`\n‚ÄºÔ∏èË°åÂàó: ${JSON.stringify(er)}`:``}${resp&&resp.status?`\n‚ÄºÔ∏èÁä∂ÊÄÅ: ${resp.status}`:``}${body?`\n‚ÄºÔ∏èÂìçÂ∫î: ${resp&&resp.status!=503?body:`Omit.`}`:``}`)
  }
  const time = () => {
    const end = ((Date.now() - start) / 1000).toFixed(2)
    return console.log('\nÁ≠æÂà∞Áî®Êó∂: ' + end + ' Áßí')
  }
  const done = (value = {}) => {
    if (isQuanX) return $done(value)
    if (isSurge) isRequest ? $done(value) : $done()
  }
  return {
    AnError,
    isRequest,
    isJSBox,
    isSurge,
    isQuanX,
    isLoon,
    isNode,
    notify,
    write,
    read,
    get,
    post,
    time,
    done
  }
};
